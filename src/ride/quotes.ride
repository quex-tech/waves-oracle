{-# STDLIB_VERSION 9 #-}
{-# CONTENT_TYPE DAPP #-}
{-# SCRIPT_TYPE ACCOUNT #-}

let z32 = base16'0000000000000000000000000000000000000000000000000000000000000000'
let rootCa = base64'MIICjzCCAjSgAwIBAgIUImUM1lqdNInzg7SVUr9QGzknBqwwCgYIKoZIzj0EAwIwaDEaMBgGA1UEAwwRSW50ZWwgU0dYIFJvb3QgQ0ExGjAYBgNVBAoMEUludGVsIENvcnBvcmF0aW9uMRQwEgYDVQQHDAtTYW50YSBDbGFyYTELMAkGA1UECAwCQ0ExCzAJBgNVBAYTAlVTMB4XDTE4MDUyMTEwNDUxMFoXDTQ5MTIzMTIzNTk1OVowaDEaMBgGA1UEAwwRSW50ZWwgU0dYIFJvb3QgQ0ExGjAYBgNVBAoMEUludGVsIENvcnBvcmF0aW9uMRQwEgYDVQQHDAtTYW50YSBDbGFyYTELMAkGA1UECAwCQ0ExCzAJBgNVBAYTAlVTMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEC6nEwMDIYZOj/iPWsCzaEKi71OiOSLRFhWGjbnBVJfVnkY4u3IjkDYYL0MxO4mqsyYjlBalTVYxFP2sJBK5zlKOBuzCBuDAfBgNVHSMEGDAWgBQiZQzWWp00ifODtJVSv1AbOScGrDBSBgNVHR8ESzBJMEegRaBDhkFodHRwczovL2NlcnRpZmljYXRlcy50cnVzdGVkc2VydmljZXMuaW50ZWwuY29tL0ludGVsU0dYUm9vdENBLmRlcjAdBgNVHQ4EFgQUImUM1lqdNInzg7SVUr9QGzknBqwwDgYDVR0PAQH/BAQDAgEGMBIGA1UdEwEB/wQIMAYBAf8CAQEwCgYIKoZIzj0EAwIDSQAwRgIhAOW/5QkR+S9CiSDcNoowLuPRLsWGf/Yi7GSX94BgwTwgAiEA4J0lrHoMs+Xo5o/sX6O9QWxHRAvZUGOdRQ7cvqRXaqI='

func fetchBlobs(addr: Address, keys: List[String]) = {
  func step(acc: List[ByteVector], k: String) = {
    acc :+ getBinaryValue(addr, k)
  }
  FOLD<10>(keys, [], step)
}

@Callable(i)
func register(
  quote: ByteVector,
  quoteSig: ByteVector,
  attestationKey: ByteVector,
  qeReport: ByteVector,
  qeReportSig: ByteVector,
  qeAuthData: ByteVector,
  qeCertChain: List[ByteVector],
  qeCrlAddr: ByteVector,
  qeCrlKeys: List[String]
) = {
  let qePk = validateCertificateChain(qeCertChain :+ rootCa, fetchBlobs(Address(qeCrlAddr), qeCrlKeys), lastBlock.timestamp)
  if !p256Verify(qeReport, qeReportSig, qePk) then
    throw("sig qe")
  else {
    if sha256_16Kb(attestationKey + qeAuthData) + z32 != takeRight(qeReport, 64) then
      throw("report-data")
    else {
      let quoteId = sha256_16Kb(quote)
      if !p256Verify(quote, quoteSig, attestationKey) then
        throw("sig quote")
      else {
        let keyBase = toBase58String(sha256_16Kb(quote)) 
        [
          BinaryEntry(keyBase + ":quote", quote),
          BinaryEntry(keyBase + ":qe-report", qeReport)
        ]
      }
    }
  }
}

@Verifier(tx)
func verify() = false
